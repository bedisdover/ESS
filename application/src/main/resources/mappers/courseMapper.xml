<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.edu.nju.mapper.courseMapper.CourseMapper">
    <insert id="addCourse" parameterType="cn.edu.nju.po.coursePO.CourseModel"
        useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_course(name, grade, class, year, term, password, enable)
        VALUES(#{name}, #{grade}, #{cls}, #{year}, #{term}, #{password}, #{enable})
    </insert>

    <insert id="addUserCourseRecord">
        INSERT INTO r_user_course VALUES (#{0}, #{1}, 1)
    </insert>

    <update id="removeUserCourseRecord">
        UPDATE r_user_course SET enable = 0
        WHERE user = #{0} AND course = #{1}
    </update>

    <update id="updateCourse" parameterType="cn.edu.nju.po.coursePO.CourseModel">
        UPDATE t_course SET
        name = #{name}, grade = #{grade}, class = #{cls},
        year = #{year}, term = #{term}, password = #{password}
        WHERE id = #{id} AND enable = 1
    </update>

    <select id="getCourseUserRecordNum" resultType="int">
        SELECT COUNT(*) FROM r_user_course WHERE course = #{1} AND user = #{0} AND enable = 1
    </select>

    <select id="getRemovedRecordNum" resultType="int">
        SELECT COUNT(*) FROM r_user_course WHERE course = #{1} AND user = #{0} AND enable = 0
    </select>

    <select id="getRemovedCourseNum" resultType="int">
        SELECT COUNT(*) FROM t_course WHERE id = #{0} AND enable = 0
    </select>

    <update id="recoverRemovedCourse">
        UPDATE t_course SET enable = 1 WHERE id = #{0}
    </update>

    <update id="recoverRemovedRecord">
        UPDATE r_user_course SET enable = 1
        WHERE user = #{0} AND course = #{1}
    </update>

    <select id="getCourseKeyById" resultType="String">
        SELECT password FROM t_course WHERE id = #{0} AND enable = 1
    </select>

    <select id="getCourseListBySize" resultType="cn.edu.nju.po.coursePO.CourseModel">
        SELECT * FROM t_course WHERE t_course.id NOT IN (
            SELECT course FROM r_user_course WHERE r_user_course.user = #{0} AND r_user_course.enable = 1
        ) AND t_course.enable = 1 LIMIT #{1}
    </select>

    <select id="getCourseListById" resultType="cn.edu.nju.po.coursePO.CourseModel">
        SELECT * FROM t_course WHERE t_course.id IN (
            SELECT course FROM r_user_course WHERE r_user_course.user = #{0} AND r_user_course.enable = 1
        ) AND t_course.enable = 1
    </select>
</mapper>